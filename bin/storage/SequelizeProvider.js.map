{"version":3,"sources":["storage/SequelizeProvider.ts"],"names":[],"mappings":"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","file":"SequelizeProvider.js","sourcesContent":["import { StorageProviderConstructor } from '../types/StorageProviderConstructor';\nimport { IStorageProvider } from './interface/IStorageProvider';\nimport { StorageProvider } from './StorageProvider';\nimport { Database } from './Database';\nimport { Util } from '../util/Util';\nimport * as Sequelize from 'sequelize';\n\n/**\n * Represents a Sequelize Model instance which represents a single\n * db table entry from the table controlled by the `SequelizeProvider`.\n */\ninterface StorageEntry extends Sequelize.Model\n{\n\tkey: string;\n\tvalue: string;\n}\n\n/**\n * Represents a Model cast type that fixes some issues with Model\n * methods that have `this` types declared\n */\ntype SequelizeModel = (new () => Sequelize.Model) & typeof Sequelize.Model;\n\nexport enum Dialect { Postgres, SQLite, MSSQL, MySQL }\n\nexport function SequelizeProvider(url: string, dialect: Dialect, debug: boolean): StorageProviderConstructor\n{\n\treturn class extends StorageProvider implements IStorageProvider\n\t{\n\t\tprivate readonly _backend: Database;\n\t\tprivate readonly _model: SequelizeModel;\n\n\t\tpublic constructor(name: string)\n\t\t{\n\t\t\tsuper();\n\n\t\t\t// Lazy load sequelize\n\t\t\tconst packages: string[] = ['sequelize-typescript', 'sequelize'];\n\t\t\tconst seq: typeof Sequelize = Util.lazyLoad<typeof Sequelize>(...packages);\n\n\t\t\tthis._backend = Database.instance(url, debug);\n\t\t\tthis._model = class extends seq.Model {};\n\n\t\t\tconst dataTypes: typeof Sequelize.DataTypes =\n\t\t\t\t(seq as any)['DataTypes']\n\t\t\t\t\t? (seq as any)['DataTypes']\n\t\t\t\t\t: (seq as any)['DataType'];\n\n\t\t\tthis._model.init(\n\t\t\t\t{\n\t\t\t\t\tkey: { type: dataTypes.STRING, allowNull: false, primaryKey: true },\n\t\t\t\t\tvalue: [Dialect.Postgres, Dialect.SQLite, Dialect.MSSQL].includes(dialect)\n\t\t\t\t\t\t? dataTypes.TEXT\n\t\t\t\t\t\t: dataTypes.TEXT({ length: 'long' })\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tmodelName: name,\n\t\t\t\t\ttimestamps: false,\n\t\t\t\t\tfreezeTableName: true,\n\t\t\t\t\tsequelize: this._backend.db\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\n\t\tpublic async init(): Promise<void>\n\t\t{\n\t\t\tawait this._backend.init();\n\t\t\tawait this._backend.db.sync();\n\t\t}\n\n\t\tpublic async keys(): Promise<string[]>\n\t\t{\n\t\t\treturn (await this._model.findAll() as StorageEntry[]).map(r => r.key);\n\t\t}\n\n\t\tpublic async get(key: string): Promise<string | undefined>\n\t\t{\n\t\t\tif (typeof key === 'undefined') throw new TypeError('Key must be provided');\n\t\t\tif (typeof key !== 'string') throw new TypeError('Key must be a string');\n\n\t\t\tconst entry: StorageEntry = await this._model.findByPk(key) as StorageEntry;\n\t\t\tif (entry === null) return;\n\n\t\t\treturn entry.value;\n\t\t}\n\n\t\tpublic async set(key: string, value: string): Promise<void>\n\t\t{\n\t\t\tif (typeof key === 'undefined') throw new TypeError('Key must be provided');\n\t\t\tif (typeof key !== 'string') throw new TypeError('Key must be a string');\n\t\t\tif (typeof value === 'undefined') throw new TypeError('Value must be provided');\n\t\t\tif (typeof value !== 'string') throw new TypeError('Value must be a string');\n\n\t\t\tawait this._model.upsert({ key, value });\n\t\t}\n\n\t\tpublic async remove(key: string): Promise<void>\n\t\t{\n\t\t\tif (typeof key === 'undefined') throw new TypeError('Key must be provided');\n\t\t\tif (typeof key !== 'string') throw new TypeError('Key must be a string');\n\t\t\tawait this._model.destroy({ where: { key } });\n\t\t}\n\n\t\tpublic async clear(): Promise<void>\n\t\t{\n\t\t\tawait this._model.destroy({ where: {} });\n\t\t}\n\t};\n}\n"],"sourceRoot":"../../src"}