{"version":3,"sources":["client/PluginLoader.ts"],"names":[],"mappings":"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","file":"PluginLoader.js","sourcesContent":["import { Client } from './Client';\nimport { Plugin } from './Plugin';\nimport { Logger, logger } from '../util/logger/Logger';\nimport { StorageProvider } from '../storage/StorageProvider';\nimport { SharedProviderStorage } from '../storage/SharedProviderStorage';\nimport { PluginConstructor } from '../types/PluginConstructor';\n\n/**\n * Loads plugins and holds loaded plugins in case accessing\n * loaded plugins at runtime is desired\n * @param {Client} client\n * @param {Array<PluginConstructor|string>} plugins\n */\nexport class PluginLoader\n{\n\t@logger('PluginLoader')\n\tprivate readonly _logger!: Logger;\n\tprivate readonly _client: Client;\n\tprivate readonly _provider: StorageProvider;\n\tprivate _plugins: (PluginConstructor | string)[];\n\n\tpublic loaded: { [name: string]: any };\n\n\tpublic constructor(client: Client, plugins: (PluginConstructor | string)[])\n\t{\n\t\tthis._client = client;\n\t\tthis._plugins = plugins;\n\t\tthis._provider = new this._client.provider('plugin_storage');\n\n\t\t/**\n\t\t * Object mapping Plugin names to Plugin instances\n\t\t * @type {object}\n\t\t */\n\t\tthis.loaded = {};\n\t}\n\n\t/**\n\t * Loads the plugins passed in the YAMDBF Client options.\n\t * Called internally by the YAMDBF Client at startup\n\t * @private\n\t */\n\tpublic async _loadPlugins(): Promise<void>\n\t{\n\t\tawait this._provider.init();\n\t\tthis._logger.debug('Plugin storage provider initialized.');\n\n\t\tfor (const [index, plugin] of this._plugins.entries())\n\t\t{\n\t\t\tlet loadedPlugin!: Plugin;\n\t\t\tif (typeof plugin === 'string')\n\t\t\t{\n\t\t\t\tlet error!: string;\n\t\t\t\tif (!/^yamdbf-/.test(plugin))\n\t\t\t\t{\n\t\t\t\t\ttry { loadedPlugin = new (require(plugin))(this._client); }\n\t\t\t\t\tcatch (err) { error = `${err}, trying 'yamdbf-${plugin}'...`; }\n\n\t\t\t\t\ttry { loadedPlugin = loadedPlugin || new (require(`yamdbf-${plugin}`))(this._client); }\n\t\t\t\t\tcatch (err)\n\t\t\t\t\t{\n\t\t\t\t\t\terror = error\n\t\t\t\t\t\t\t? `${error}\\n${err}, trying '@yamdbf/${plugin}'...`\n\t\t\t\t\t\t\t: `${err}, trying '@yamdbf/${plugin}'...`;\n\t\t\t\t\t}\n\n\t\t\t\t\ttry { loadedPlugin = loadedPlugin || new (require(`@yamdbf/${plugin}`))(this._client); }\n\t\t\t\t\tcatch (err) { error = error ? `${error}\\n${err}` : err; }\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\ttry { loadedPlugin = new (require(plugin))(this._client); }\n\t\t\t\t\tcatch (err) { error = err; }\n\t\t\t\t}\n\n\t\t\t\tif (!loadedPlugin) {\n\t\t\t\t\tthis._logger.warn(`Failed to load plugin '${plugin}':\\n\\n${error}\\n`);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\ttry { loadedPlugin = new plugin(this._client); }\n\t\t\t\tcatch (err)\n\t\t\t\t{\n\t\t\t\t\tthis._logger.warn(`Failed to load plugin at plugins[${index}]:\\n\\n${err}\\n`);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (typeof loadedPlugin.name === 'undefined' || loadedPlugin.name === '')\n\t\t\t{\n\t\t\t\tthis._logger.warn(`Plugin at plugins[${index}] is invalid: Missing name`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (typeof loadedPlugin.init === 'undefined')\n\t\t\t{\n\t\t\t\tthis._logger.warn(`Plugin at plugins[${index}] is invalid: Missing init()`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (typeof this.loaded[loadedPlugin.name] !== 'undefined')\n\t\t\t{\n\t\t\t\tthis._logger.warn(`Skipping Plugin at plugins[${index}]: Duplicate name '${loadedPlugin.name}'`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tlet pluginStorage!: SharedProviderStorage;\n\t\t\ttry { pluginStorage = new SharedProviderStorage(this._provider, loadedPlugin.name); }\n\t\t\tcatch { this._logger.warn(`Failed to create storage for Plugin '${loadedPlugin.name}'`); }\n\n\t\t\ttry { await pluginStorage.init(); }\n\t\t\tcatch { this._logger.warn(`Failed to initialize storage for Plugin '${loadedPlugin.name}'`); }\n\n\t\t\tthis._logger.info(`Plugin '${loadedPlugin.name}' loaded, initializing...`);\n\t\t\ttry\n\t\t\t{\n\t\t\t\tawait loadedPlugin.init(pluginStorage);\n\t\t\t\tthis._logger.info(`Plugin '${loadedPlugin.name}' initialized.`);\n\t\t\t}\n\t\t\tcatch (err)\n\t\t\t{\n\t\t\t\tthis._logger.warn(`Plugin '${loadedPlugin.name}' errored during initialization:\\n\\n${err.stack}`,\n\t\t\t\t\t'\\n\\nPlease report this error to the plugin author.\\n');\n\t\t\t\tthis._logger.info(`Plugin '${loadedPlugin.name}' initialized with errors.`);\n\t\t\t}\n\t\t\tthis.loaded[loadedPlugin.name] = loadedPlugin;\n\t\t}\n\t}\n}\n"],"sourceRoot":"../../src"}