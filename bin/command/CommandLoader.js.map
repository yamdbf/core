{"version":3,"sources":["command/CommandLoader.ts"],"names":[],"mappings":"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","file":"CommandLoader.js","sourcesContent":["import * as Glob from 'glob';\nimport * as Path from 'path';\nimport { Client } from '../client/Client';\nimport { Logger, logger } from '../util/logger/Logger';\nimport { CommandRegistry } from './CommandRegistry';\nimport { Command } from './Command';\nimport { BaseCommandName } from '../types/BaseCommandName';\nimport { Util } from '../util/Util';\n\n/**\n * Handles loading all commands from the given Client's commandsDir\n * @private\n */\nexport class CommandLoader\n{\n\t@logger('CommandLoader')\n\tprivate readonly _logger!: Logger;\n\tprivate readonly _client: Client;\n\tprivate readonly _commands: CommandRegistry<any>;\n\n\tpublic constructor(client: Client)\n\t{\n\t\tthis._client = client;\n\t\tthis._commands = client.commands;\n\t}\n\n\t/**\n\t * Load commands from the given directory\n\t * @param {string} path Directory to load from\n\t * @param {boolean} [base=false] Whether or not the commands being loaded are base commands\n\t * @returns {number} The number of Commands loaded from the directory\n\t */\n\tpublic loadCommandsFrom(dir: string, base: boolean = false): number\n\t{\n\t\tconst path: string = Path.resolve(dir);\n\n\t\t// Glob all the javascript files in the directory\n\t\tlet commandFiles: string[] = Glob.sync(`${path}/**/*.js`);\n\n\t\t// Glob typescript files if `tsNode` is enabled\n\t\tif (this._client.tsNode)\n\t\t{\n\t\t\tcommandFiles.push(...Glob.sync(`${path}/**/!(*.d).ts`));\n\t\t\tconst filteredCommandFiles = commandFiles.filter(f => {\n\t\t\t\tconst file: string = f.match('/([^\\/]+?)\\.[j|t]s$')![1];\n\t\t\t\tif (f.endsWith('.ts')) return true;\n\t\t\t\tif (f.endsWith('.js'))\n\t\t\t\t\treturn !commandFiles.find(cf => cf.endsWith(`${file}.ts`));\n\t\t\t});\n\t\t\tcommandFiles = filteredCommandFiles;\n\t\t}\n\n\t\tconst loadedCommands: Command[] = [];\n\t\tthis._logger.debug(`Loading commands in: ${path}`);\n\n\t\t// Load and instantiate every command from the globbed files\n\t\tfor (const file of commandFiles)\n\t\t{\n\t\t\t// Delete the cached command file for hot-reloading\n\t\t\tdelete require.cache[require.resolve(file)];\n\n\t\t\tconst loadedFile: any = require(file);\n\t\t\tconst commandClasses: (new () => Command)[] = this._findCommandClasses(loadedFile);\n\n\t\t\tif (commandClasses.length === 0)\n\t\t\t{\n\t\t\t\tthis._logger.warn(`Failed to find Command class in file: ${file}`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tfor (const commandClass of commandClasses)\n\t\t\t{\n\t\t\t\tconst commandInstance: Command = new commandClass();\n\n\t\t\t\t// Don't load disabled base commands\n\t\t\t\tif (base && this._client.disableBase\n\t\t\t\t\t.includes(commandInstance.name as BaseCommandName))\n\t\t\t\t\tcontinue;\n\n\t\t\t\tthis._logger.info(`Loaded command: ${commandInstance.name}`);\n\t\t\t\tcommandInstance._classloc = file;\n\t\t\t\tloadedCommands.push(commandInstance);\n\t\t\t}\n\t\t}\n\n\t\t// Register all of the loaded commands\n\t\tfor (const command of loadedCommands)\n\t\t\tthis._commands._registerInternal(command);\n\n\t\treturn loadedCommands.length;\n\t}\n\n\t/**\n\t * Recursively search for Command classes within the given object\n\t * @private\n\t */\n\tprivate _findCommandClasses(obj: any): (new () => Command)[]\n\t{\n\t\tconst foundClasses: ((new () => Command) | (new () => Command)[])[] = [];\n\t\tconst keys: string[] = Object.keys(obj);\n\t\tif (Command.prototype.isPrototypeOf(obj.prototype))\n\t\t\tfoundClasses.push(obj);\n\n\t\telse if (keys.length > 0)\n\t\t\tfor (const key of keys)\n\t\t\t\tif (Command.prototype.isPrototypeOf(obj[key].prototype))\n\t\t\t\t\tfoundClasses.push(this._findCommandClasses(obj[key]));\n\n\t\treturn Util.flattenArray(foundClasses);\n\t}\n}\n"],"sourceRoot":"../../src"}