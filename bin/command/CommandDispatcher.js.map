{"version":3,"sources":["command/CommandDispatcher.ts"],"names":[],"mappings":"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","file":"CommandDispatcher.js","sourcesContent":["import { PermissionResolvable, TextChannel, User, MessageOptions, Message as DMessage } from 'discord.js';\nimport { MiddlewareFunction } from '../types/MiddlewareFunction';\nimport { Logger, logger } from '../util/logger/Logger';\nimport { Message } from '../types/Message';\nimport { GuildStorage } from '../storage/GuildStorage';\nimport { Command } from '../command/Command';\nimport { Client } from '../client/Client';\nimport { RateLimitManager } from './RateLimitManager';\nimport { RateLimit } from './RateLimit';\nimport { Time } from '../util/Time';\nimport { Lang } from '../localization/Lang';\nimport { ResourceProxy } from '../types/ResourceProxy';\nimport { BaseStrings as s } from '../localization/BaseStrings';\nimport { Util } from '../util/Util';\nimport { format } from 'util';\n\n/**\n * Handles dispatching commands\n * @private\n */\nexport class CommandDispatcher\n{\n\t@logger private readonly _logger: Logger;\n\tprivate readonly _client: Client;\n\tprivate _ready: boolean = false;\n\n\tpublic constructor(client: Client)\n\t{\n\t\tthis._client = client;\n\n\t\tif (!this._client.passive)\n\t\t\tthis._client.on('message', message =>\n\t\t\t\t{ if (this._ready) this.handleMessage(message); });\n\t}\n\n\t/**\n\t * Set the dispatcher as ready to receive and dispatch commands\n\t */\n\tpublic setReady(): void\n\t{\n\t\tthis._ready = true;\n\t}\n\n\t/**\n\t * Handle received messages\n\t */\n\tprivate async handleMessage(message: Message): Promise<void>\n\t{\n\t\tconst dispatchStart: number = Util.now();\n\t\tconst dm: boolean = message.channel.type !== 'text';\n\n\t\t// Don't continue for bots and don't continue\n\t\t// for other users when the client is a selfbot\n\t\tif (message.author.bot) return;\n\t\tif (this._client.selfbot && message.author.id !== this._client.user.id) return;\n\n\t\t// Set `message.guild.storage` if message is not a DM\n\t\tif (!dm) message.guild.storage = this._client.storage.guilds.get(message.guild.id);\n\n\t\t// Don't bother with anything else if author is blacklisted\n\t\tif (await this.isBlacklisted(message.author, message, dm)) return;\n\n\t\tconst lang: string = await Lang.getLangFromMessage(message);\n\t\tconst res: ResourceProxy = Lang.createResourceProxy(lang);\n\n\t\ttype CommandCallData = [boolean, Command, string, string];\n\t\tlet [commandWasCalled, command, prefix, name]: CommandCallData =\n\t\t\tawait Util.wasCommandCalled(message);\n\n\t\tif (!commandWasCalled)\n\t\t{\n\t\t\t// Handle shortcuts\n\t\t\tif (!dm)\n\t\t\t{\n\t\t\t\tlet shortcuts: { [name: string]: string } =\n\t\t\t\t\tawait message.guild.storage.settings.get('shortcuts') || {};\n\n\t\t\t\tif (shortcuts && prefix && name && shortcuts[name])\n\t\t\t\t{\n\t\t\t\t\tconst shortcutName: string = name;\n\t\t\t\t\tconst call: RegExp = new RegExp(`^${Util.escape(prefix)} *${name}`);\n\t\t\t\t\tconst oldArgsStr: string = message.content.replace(call, '');\n\t\t\t\t\tconst newCommand: string = `${prefix}${shortcuts[name]}`;\n\n\t\t\t\t\tmessage.content = newCommand;\n\t\t\t\t\t[commandWasCalled, command, prefix, name] = await Util.wasCommandCalled(message);\n\n\t\t\t\t\tconst shortcutArgs: string[] = this._client.argsParser(oldArgsStr, command, message);\n\t\t\t\t\tmessage.content = format(newCommand, ...shortcutArgs);\n\n\t\t\t\t\tif (!commandWasCalled)\n\t\t\t\t\t\tmessage.channel.send(res.DISPATCHER_ERR_INVALID_SHORTCUT({ name: shortcutName }));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Send unknownCommandError in DMs\n\t\t\tif (dm && this._client.unknownCommandError)\n\t\t\t\tmessage.channel.send(this.unknownCommandError(res));\n\n\t\t\t// Emit an `unknownCommand` event and return if no\n\t\t\t// command or shortcut was called\n\t\t\tif (!commandWasCalled)\n\t\t\t{\n\t\t\t\tconst call: RegExp = new RegExp(`^${Util.escape(prefix || '')} *${name}`);\n\t\t\t\tconst argsStr: string = message.content.replace(call, '');\n\t\t\t\tconst unknownCommandArgs: any[] = this._client.argsParser(argsStr);\n\t\t\t\tthis._client.emit('unknownCommand', name, unknownCommandArgs, message);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tlet validCall: boolean = false;\n\t\ttry { validCall = await this.canCallCommand(res, <Command> command, message, dm); }\n\t\tcatch (err) { message[this._client.selfbot ? 'channel' : 'author'].send(err); }\n\t\tif (!validCall) return;\n\n\t\t// Remove clientuser from message.mentions if only mentioned one time as a prefix\n\t\tconst clientMention: RegExp = new RegExp(`<@!?${this._client.user.id}>`, 'g');\n\t\tconst startsWithClientMention: RegExp = new RegExp(`^${clientMention.source}`);\n\t\tif (startsWithClientMention.test(message.content)\n\t\t\t&& (message.content.match(clientMention) || []).length === 1)\n\t\t\tmessage.mentions.users.delete(this._client.user.id);\n\n\t\t// Prepare args\n\t\tconst preppedInput: string = message.content.replace(prefix, '').replace(name, '').trim();\n\t\tlet args: string[] = this._client.argsParser(preppedInput, command, message);\n\n\t\ttype Result = string | MessageOptions | Message;\n\t\ttype CommandResult = Result | Result[] | Promise<Result> | Promise<Result[]>;\n\t\ttype MiddlewareResult = [Message, any[]] | Promise<[Message, any[]]> | string | Error;\n\n\t\tlet commandResult: CommandResult;\n\t\tlet middlewarePassed: boolean = true;\n\t\tlet middleware: MiddlewareFunction[] = this._client._middleware.concat(command._middleware);\n\t\tfor (let func of middleware)\n\t\t\ttry\n\t\t\t{\n\t\t\t\tlet result: MiddlewareResult = func.call(command, message, args);\n\t\t\t\tif (result instanceof Promise) result = await result;\n\t\t\t\tif (!(result instanceof Array))\n\t\t\t\t{\n\t\t\t\t\tif (typeof result === 'string') commandResult = await message.channel.send(result);\n\t\t\t\t\tmiddlewarePassed = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t[message, args] = result;\n\t\t\t}\n\t\t\tcatch (err)\n\t\t\t{\n\t\t\t\tcommandResult = await message.channel.send(err.toString(), { split: true });\n\t\t\t\tmiddlewarePassed = false;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\tif (!middlewarePassed) return;\n\n\t\ttry { commandResult = await command.action(message, args); }\n\t\tcatch (err) { this._logger.error(`Dispatch:${command.name}`, err.stack); }\n\n\t\tif (commandResult !== null\n\t\t\t&& typeof commandResult !== 'undefined'\n\t\t\t&& !(commandResult instanceof Array)\n\t\t\t&& !(commandResult instanceof DMessage))\n\t\t\tcommandResult = await message.channel.send(<string> commandResult);\n\n\t\t// commandResult = Util.flattenArray([<Message | Message[]> commandResult]);\n\t\t// TODO: Store command result information for command editing\n\n\t\tconst dispatchEnd: number = Util.now() - dispatchStart;\n\t\tthis._client.emit('command', command.name, args, dispatchEnd, message);\n\t}\n\n\t/**\n\t * Check if the calling user is blacklisted\n\t */\n\tprivate async isBlacklisted(user: User, message: Message, dm: boolean): Promise<boolean>\n\t{\n\t\tif (await this._client.storage.get(`blacklist.${user.id}`)) return true;\n\t\tif (!dm && await message.guild.storage.settings.get(`blacklist.${user.id}`)) return true;\n\t\treturn false;\n\t}\n\n\t/**\n\t * Return whether or not the command is allowed to be called based\n\t * on whatever circumstances are present at call-time, throwing\n\t * appropriate errors as necessary for unsatisfied conditions\n\t */\n\tprivate async canCallCommand(res: ResourceProxy, command: Command, message: Message, dm: boolean): Promise<boolean>\n\t{\n\t\tconst storage: GuildStorage = !dm ? this._client.storage.guilds.get(message.guild.id) : null;\n\n\t\tif (command.ownerOnly && !this._client.isOwner(message.author)) return false;\n\t\tif (!dm && (await storage.settings.get('disabledGroups') || []).includes(command.group)) return false;\n\t\tif (!this.passedRateLimiters(res, message, command)) return false;\n\n\t\tif (dm && command.guildOnly)\n\t\t\tthrow this.guildOnlyError(res);\n\n\t\tconst missingClientPermissions: PermissionResolvable[] = this.checkClientPermissions(command, message, dm);\n\t\tif (missingClientPermissions.length > 0)\n\t\t{\n\t\t\t// Explicitly send this error to the channel rather than throwing\n\t\t\tmessage.channel.send(this.missingClientPermissionsError(res, missingClientPermissions));\n\t\t\treturn false;\n\t\t}\n\n\t\tconst missingCallerPermissions: PermissionResolvable[] = this.checkCallerPermissions(command, message, dm);\n\t\tif (missingCallerPermissions.length > 0)\n\t\t\tthrow this.missingCallerPermissionsError(res, missingCallerPermissions);\n\n\t\tif (!(await this.passedRoleLimiter(command, message, dm)))\n\t\t\tthrow await this.failedLimiterError(res, command, message);\n\n\t\tif (!this.hasRoles(command, message, dm))\n\t\t\tthrow this.missingRolesError(res, command);\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Return whether or not the message author passed global\n\t * and command-specific ratelimits for the given command\n\t */\n\tprivate passedRateLimiters(res: ResourceProxy, message: Message, command: Command): boolean\n\t{\n\t\tconst passedGlobal: boolean = !this.isRateLimited(res, message, command, true);\n\t\tconst passedCommand: boolean = !this.isRateLimited(res, message, command);\n\t\tconst passedAllLimiters: boolean = passedGlobal && passedCommand;\n\n\t\tif (passedAllLimiters)\n\t\t{\n\t\t\tconst manager: RateLimitManager = this._client.rateLimitManager;\n\t\t\tconst limit: string = command.ratelimit;\n\t\t\tconst identifier: string = command.ratelimit ? command.name : 'global';\n\t\t\tconst descriptors: string[] = [message.author.id, identifier];\n\n\t\t\tif (!(limit && !manager.call(limit, ...descriptors)) && this._client.ratelimit)\n\t\t\t\tmanager.call(this._client.ratelimit, message.author.id, 'global');\n\t\t}\n\n\t\treturn passedAllLimiters;\n\t}\n\n\t/**\n\t * Check global or command-specific ratelimits for the given message\n\t * author, notify them if they exceed ratelimits, and return whether\n\t * or not the user is ratelimited\n\t */\n\tprivate isRateLimited(res: ResourceProxy, message: Message, command: Command, global: boolean = false): boolean\n\t{\n\t\tconst manager: RateLimitManager = this._client.rateLimitManager;\n\t\tconst limit: string = command.ratelimit || this._client.ratelimit;\n\t\tif (!limit) return false;\n\n\t\tconst identifier: string = command.ratelimit ? !global ? command.name : 'global' : 'global';\n\t\tconst descriptors: string[] = [message.author.id, identifier];\n\t\tconst rateLimit: RateLimit = manager.get(limit, ...descriptors);\n\t\tif (!rateLimit.isLimited) return false;\n\n\t\tif (!rateLimit.wasNotified)\n\t\t{\n\t\t\tconst globalLimitString: string = this._client.ratelimit;\n\t\t\tconst globalLimit: RateLimit = globalLimitString\n\t\t\t\t? manager.get(globalLimitString, message.author.id, 'global')\n\t\t\t\t: null;\n\t\t\tif (globalLimit && globalLimit.isLimited && globalLimit.wasNotified) return true;\n\n\t\t\ttype RateLimitErrorString = s.DISPATCHER_ERR_RATELIMIT_EXCEED_GLOBAL | s.DISPATCHER_ERR_RATELIMIT_EXCEED;\n\t\t\tconst errStr: RateLimitErrorString = global\n\t\t\t\t? s.DISPATCHER_ERR_RATELIMIT_EXCEED_GLOBAL\n\t\t\t\t: s.DISPATCHER_ERR_RATELIMIT_EXCEED;\n\n\t\t\trateLimit.setNotified();\n\t\t\tmessage.channel.send(res[errStr]({ time: Time.difference(rateLimit.expires, Date.now()).toString() }));\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Return permissions the client is missing to execute the given command\n\t */\n\tprivate checkClientPermissions(command: Command, message: Message, dm: boolean): PermissionResolvable[]\n\t{\n\t\treturn dm ? [] : command.clientPermissions.filter(a =>\n\t\t\t!(<TextChannel> message.channel).permissionsFor(this._client.user).has(a));\n\t}\n\n\t/**\n\t * Return the permissions the caller is missing to call the given command\n\t */\n\tprivate checkCallerPermissions(command: Command, message: Message, dm: boolean): PermissionResolvable[]\n\t{\n\t\treturn this._client.selfbot || dm ? [] : command.callerPermissions.filter(a =>\n\t\t\t!(<TextChannel> message.channel).permissionsFor(message.author).has(a));\n\t}\n\n\t/**\n\t * Return whether or not the message author passes the role limiter\n\t */\n\tprivate async passedRoleLimiter(command: Command, message: Message, dm: boolean): Promise<boolean>\n\t{\n\t\tif (dm || this._client.selfbot) return true;\n\n\t\tconst storage: GuildStorage = this._client.storage.guilds.get(message.guild.id);\n\t\tconst limitedCommands: { [name: string]: string[] } = await storage.settings.get('limitedCommands') || {};\n\n\t\tif (!limitedCommands[command.name]) return true;\n\t\tif (limitedCommands[command.name].length === 0) return true;\n\n\t\treturn message.member.roles.filter(role =>\n\t\t\tlimitedCommands[command.name].includes(role.id)).size > 0;\n\t}\n\n\t/**\n\t * Return whether or not the user has one of the roles specified\n\t * in the command's requisite roles\n\t */\n\tprivate hasRoles(command: Command, message: Message, dm: boolean): boolean\n\t{\n\t\treturn this._client.selfbot || command.roles.length === 0 || dm\n\t\t\t|| message.member.roles.filter(role =>\n\t\t\t\tcommand.roles.includes(role.name)).size > 0;\n\t}\n\n\t/**\n\t * Return an error for unknown commands in DMs\n\t */\n\tprivate unknownCommandError(res: ResourceProxy): string\n\t{\n\t\treturn res.DISPATCHER_ERR_UNKNOWN_COMMAND();\n\t}\n\n\t/**\n\t * Return an error for guild only commands\n\t */\n\tprivate guildOnlyError(res: ResourceProxy): string\n\t{\n\t\treturn res.DISPATCHER_ERR_GUILD_ONLY();\n\t}\n\n\t/**\n\t * Return an error for missing caller permissions\n\t */\n\tprivate missingClientPermissionsError(res: ResourceProxy, missing: PermissionResolvable[]): string\n\t{\n\t\treturn res.DISPATCHER_ERR_MISSING_CLIENT_PERMISSIONS({ missing: missing.join(', ') });\n\t}\n\n\t/**\n\t * Return an error for missing caller permissions\n\t */\n\tprivate missingCallerPermissionsError(res: ResourceProxy, missing: PermissionResolvable[]): string\n\t{\n\t\treturn res.DISPATCHER_ERR_MISSING_CALLER_PERMISSIONS({ missing: missing.join(', ') });\n\t}\n\n\t/**\n\t * Return an error for failing a command limiter\n\t */\n\tprivate async failedLimiterError(res: ResourceProxy, command: Command, message: Message): Promise<string>\n\t{\n\t\tconst storage: GuildStorage = this._client.storage.guilds.get(message.guild.id);\n\t\tconst limitedCommands: { [name: string]: string[] } = await storage.settings.get('limitedCommands');\n\t\tconst roles: string[] = message.guild.roles\n\t\t\t.filter(r => limitedCommands[command.name].includes(r.id))\n\t\t\t.map(r => r.name);\n\n\t\treturn res.DISPATCHER_ERR_MISSING_ROLES({ roles: roles.join(', ')});\n\t}\n\n\t/**\n\t * Return an error for missing roles\n\t */\n\tprivate missingRolesError(res: ResourceProxy, command: Command): string\n\t{\n\t\treturn res.DISPATCHER_ERR_MISSING_ROLES({ roles: command.roles.join(', ') });\n\t}\n}\n"],"sourceRoot":"../../src"}