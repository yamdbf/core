{"version":3,"sources":["command/CommandDispatcher.ts"],"names":[],"mappings":"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","file":"CommandDispatcher.js","sourcesContent":["import { PermissionResolvable, TextChannel, User, MessageOptions, Message as DMessage } from 'discord.js';\nimport { MiddlewareFunction } from '../types/MiddlewareFunction';\nimport { ResourceLoader } from '../types/ResourceLoader';\nimport { BaseStrings as s } from '../localization/BaseStrings';\nimport { Logger, logger } from '../util/logger/Logger';\nimport { Message } from '../types/Message';\nimport { GuildStorage } from '../storage/GuildStorage';\nimport { Command } from '../command/Command';\nimport { Client } from '../client/Client';\nimport { RateLimitManager } from './RateLimitManager';\nimport { RateLimit } from './RateLimit';\nimport { Time } from '../util/Time';\nimport { Lang } from '../localization/Lang';\nimport { Util } from '../util/Util';\nimport { format } from 'util';\n\n/**\n * Handles dispatching commands\n * @private\n */\nexport class CommandDispatcher\n{\n\t@logger private readonly _logger: Logger;\n\tprivate readonly _client: Client;\n\tprivate _ready: boolean = false;\n\n\tpublic constructor(client: Client)\n\t{\n\t\tthis._client = client;\n\n\t\tif (!this._client.passive)\n\t\t\tthis._client.on('message', message =>\n\t\t\t\t{ if (this._ready) this.handleMessage(message); });\n\t}\n\n\t/**\n\t * Set the dispatcher as ready to receive and dispatch commands\n\t */\n\tpublic setReady(): void\n\t{\n\t\tthis._ready = true;\n\t}\n\n\t/**\n\t * Handle received messages\n\t */\n\tprivate async handleMessage(message: Message): Promise<void>\n\t{\n\t\tconst dispatchStart: number = Util.now();\n\t\tconst dm: boolean = message.channel.type !== 'text';\n\n\t\t// Don't continue for bots and don't continue\n\t\t// for other users when the client is a selfbot\n\t\tif (message.author.bot) return;\n\t\tif (this._client.selfbot && message.author.id !== this._client.user.id) return;\n\n\t\t// Set `message.guild.storage` if message is not a DM\n\t\tif (!dm) message.guild.storage = this._client.storage.guilds.get(message.guild.id);\n\n\t\t// Don't bother with anything else if author is blacklisted\n\t\tif (await this.isBlacklisted(message.author, message, dm)) return;\n\n\t\tconst lang: string = dm\n\t\t\t? this._client.defaultLang\n\t\t\t: await message.guild.storage.settings.get('lang')\n\t\t\t\t|| this._client.defaultLang;\n\t\tconst res: ResourceLoader = Lang.createResourceLoader(lang);\n\n\t\ttype CommandCallData = [boolean, Command, string, string];\n\t\tlet [commandWasCalled, command, prefix, name]: CommandCallData =\n\t\t\tawait Util.wasCommandCalled(message);\n\n\t\tif (!commandWasCalled)\n\t\t{\n\t\t\t// Handle shortcuts\n\t\t\tif (!dm)\n\t\t\t{\n\t\t\t\tlet shortcuts: { [name: string]: string } =\n\t\t\t\t\tawait message.guild.storage.settings.get('shortcuts') || {};\n\n\t\t\t\tif (shortcuts && prefix && name && shortcuts[name])\n\t\t\t\t{\n\t\t\t\t\tconst shortcutName: string = name;\n\t\t\t\t\tconst call: RegExp = new RegExp(`^${Util.escape(prefix)} *${name}`);\n\t\t\t\t\tconst oldArgsStr: string = message.content.replace(call, '');\n\t\t\t\t\tconst newCommand: string = `${prefix}${shortcuts[name]}`;\n\n\t\t\t\t\tmessage.content = newCommand;\n\t\t\t\t\t[commandWasCalled, command, prefix, name] = await Util.wasCommandCalled(message);\n\n\t\t\t\t\tconst shortcutArgs: string[] = this._client.argsParser(oldArgsStr, command, message);\n\t\t\t\t\tmessage.content = format(newCommand, ...shortcutArgs);\n\n\t\t\t\t\tif (!commandWasCalled)\n\t\t\t\t\t\tmessage.channel.send(res(s.DISPATCHER_ERR_INVALID_SHORTCUT, { name: shortcutName }));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Send unknownCommandError in DMs\n\t\t\tif (dm && this._client.unknownCommandError)\n\t\t\t\tmessage.channel.send(this.unknownCommandError(res));\n\n\t\t\tif (!commandWasCalled) return;\n\t\t}\n\n\t\tlet validCall: boolean = false;\n\t\ttry { validCall = await this.canCallCommand(res, <Command> command, message, dm); }\n\t\tcatch (err) { message[this._client.selfbot ? 'channel' : 'author'].send(err); }\n\t\tif (!validCall) return;\n\n\t\t// Remove clientuser from message.mentions if only mentioned one time as a prefix\n\t\tconst clientMention: RegExp = new RegExp(`<@!?${this._client.user.id}>`, 'g');\n\t\tconst startsWithClientMention: RegExp = new RegExp(`^${clientMention.source}`);\n\t\tif (startsWithClientMention.test(message.content)\n\t\t\t&& (message.content.match(clientMention) || []).length === 1)\n\t\t\tmessage.mentions.users.delete(this._client.user.id);\n\n\t\t// Prepare args\n\t\tconst preppedInput: string = message.content.replace(prefix, '').replace(name, '').trim();\n\t\tlet args: string[] = this._client.argsParser(preppedInput, command, message);\n\n\t\ttype Result = string | MessageOptions | Message;\n\t\ttype CommandResult = Result | Result[] | Promise<Result> | Promise<Result[]>;\n\t\ttype MiddlewareResult = [Message, any[]] | Promise<[Message, any[]]> | string | Error;\n\n\t\tlet commandResult: CommandResult;\n\t\tlet middlewarePassed: boolean = true;\n\t\tlet middleware: MiddlewareFunction[] = this._client._middleware.concat(command._middleware);\n\t\tfor (let func of middleware)\n\t\t\ttry\n\t\t\t{\n\t\t\t\tlet result: MiddlewareResult = func.call(command, message, args);\n\t\t\t\tif (result instanceof Promise) result = await result;\n\t\t\t\tif (!(result instanceof Array))\n\t\t\t\t{\n\t\t\t\t\tif (typeof result === 'string') commandResult = await message.channel.send(result);\n\t\t\t\t\tmiddlewarePassed = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t[message, args] = result;\n\t\t\t}\n\t\t\tcatch (err)\n\t\t\t{\n\t\t\t\tcommandResult = await message.channel.send(err.toString(), { split: true });\n\t\t\t\tmiddlewarePassed = false;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\tif (!middlewarePassed) return;\n\n\t\ttry { commandResult = await command.action(message, args); }\n\t\tcatch (err) { this._logger.error(`Dispatch:${command.name}`, err.stack); }\n\n\t\tif (commandResult !== null\n\t\t\t&& typeof commandResult !== 'undefined'\n\t\t\t&& !(commandResult instanceof Array)\n\t\t\t&& !(commandResult instanceof DMessage))\n\t\t\tcommandResult = await message.channel.send(<string> commandResult);\n\n\t\t// commandResult = Util.flattenArray([<Message | Message[]> commandResult]);\n\t\t// TODO: Store command result information for command editing\n\n\t\tconst dispatchEnd: number = Util.now() - dispatchStart;\n\t\tthis._client.emit('command', command.name, args, dispatchEnd, message);\n\t}\n\n\t/**\n\t * Check if the calling user is blacklisted\n\t */\n\tprivate async isBlacklisted(user: User, message: Message, dm: boolean): Promise<boolean>\n\t{\n\t\tif (await this._client.storage.get(`blacklist.${user.id}`)) return true;\n\t\tif (!dm && await message.guild.storage.settings.get(`blacklist.${user.id}`)) return true;\n\t\treturn false;\n\t}\n\n\t/**\n\t * Return whether or not the command is allowed to be called based\n\t * on whatever circumstances are present at call-time, throwing\n\t * appropriate errors as necessary for unsatisfied conditions\n\t */\n\tprivate async canCallCommand(res: ResourceLoader, command: Command, message: Message, dm: boolean): Promise<boolean>\n\t{\n\t\tconst storage: GuildStorage = !dm ? this._client.storage.guilds.get(message.guild.id) : null;\n\n\t\tif (command.ownerOnly && !this._client.isOwner(message.author)) return false;\n\t\tif (!dm && (await storage.settings.get('disabledGroups') || []).includes(command.group)) return false;\n\t\tif (!this.passedRateLimiters(res, message, command)) return false;\n\n\t\tif (dm && command.guildOnly)\n\t\t\tthrow this.guildOnlyError(res);\n\n\t\tconst missingClientPermissions: PermissionResolvable[] = this.checkClientPermissions(command, message, dm);\n\t\tif (missingClientPermissions.length > 0)\n\t\t{\n\t\t\t// Explicitly send this error to the channel rather than throwing\n\t\t\tmessage.channel.send(this.missingClientPermissionsError(res, missingClientPermissions));\n\t\t\treturn false;\n\t\t}\n\n\t\tconst missingCallerPermissions: PermissionResolvable[] = this.checkCallerPermissions(command, message, dm);\n\t\tif (missingCallerPermissions.length > 0)\n\t\t\tthrow this.missingCallerPermissionsError(res, missingCallerPermissions);\n\n\t\tif (!(await this.passedRoleLimiter(command, message, dm)))\n\t\t\tthrow await this.failedLimiterError(res, command, message);\n\n\t\tif (!this.hasRoles(command, message, dm))\n\t\t\tthrow this.missingRolesError(res, command);\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Return whether or not the message author passed global\n\t * and command-specific ratelimits for the given command\n\t */\n\tprivate passedRateLimiters(res: ResourceLoader, message: Message, command: Command): boolean\n\t{\n\t\tconst passedGlobal: boolean = !this.isRateLimited(res, message, command, true);\n\t\tconst passedCommand: boolean = !this.isRateLimited(res, message, command);\n\t\tconst passedAllLimiters: boolean = passedGlobal && passedCommand;\n\n\t\tif (passedAllLimiters)\n\t\t{\n\t\t\tconst manager: RateLimitManager = this._client.rateLimitManager;\n\t\t\tconst limit: string = command.ratelimit;\n\t\t\tconst identifier: string = command.ratelimit ? command.name : 'global';\n\t\t\tconst descriptors: string[] = [message.author.id, identifier];\n\n\t\t\tif (!(limit && !manager.call(limit, ...descriptors)) && this._client.ratelimit)\n\t\t\t\tmanager.call(this._client.ratelimit, message.author.id, 'global');\n\t\t}\n\n\t\treturn passedAllLimiters;\n\t}\n\n\t/**\n\t * Check global or command-specific ratelimits for the given message\n\t * author, notify them if they exceed ratelimits, and return whether\n\t * or not the user is ratelimited\n\t */\n\tprivate isRateLimited(res: ResourceLoader, message: Message, command: Command, global: boolean = false): boolean\n\t{\n\t\tconst manager: RateLimitManager = this._client.rateLimitManager;\n\t\tconst limit: string = command.ratelimit || this._client.ratelimit;\n\t\tif (!limit) return false;\n\n\t\tconst identifier: string = command.ratelimit ? !global ? command.name : 'global' : 'global';\n\t\tconst descriptors: string[] = [message.author.id, identifier];\n\t\tconst rateLimit: RateLimit = manager.get(limit, ...descriptors);\n\t\tif (!rateLimit.isLimited) return false;\n\n\t\tif (!rateLimit.wasNotified)\n\t\t{\n\t\t\tconst globalLimitString: string = this._client.ratelimit;\n\t\t\tconst globalLimit: RateLimit = globalLimitString\n\t\t\t\t? manager.get(globalLimitString, message.author.id, 'global')\n\t\t\t\t: null;\n\t\t\tif (globalLimit && globalLimit.isLimited && globalLimit.wasNotified) return true;\n\n\t\t\trateLimit.setNotified();\n\t\t\tmessage.channel.send(res(global\n\t\t\t\t? s.DISPATCHER_ERR_RATELIMIT_EXCEED_GLOBAL\n\t\t\t\t: s.DISPATCHER_ERR_RATELIMIT_EXCEED,\n\t\t\t\t{ time: Time.difference(rateLimit.expires, Date.now()).toString() }));\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Return permissions the client is missing to execute the given command\n\t */\n\tprivate checkClientPermissions(command: Command, message: Message, dm: boolean): PermissionResolvable[]\n\t{\n\t\treturn dm ? [] : command.clientPermissions.filter(a =>\n\t\t\t!(<TextChannel> message.channel).permissionsFor(this._client.user).has(a));\n\t}\n\n\t/**\n\t * Return the permissions the caller is missing to call the given command\n\t */\n\tprivate checkCallerPermissions(command: Command, message: Message, dm: boolean): PermissionResolvable[]\n\t{\n\t\treturn this._client.selfbot || dm ? [] : command.callerPermissions.filter(a =>\n\t\t\t!(<TextChannel> message.channel).permissionsFor(message.author).has(a));\n\t}\n\n\t/**\n\t * Return whether or not the message author passes the role limiter\n\t */\n\tprivate async passedRoleLimiter(command: Command, message: Message, dm: boolean): Promise<boolean>\n\t{\n\t\tif (dm || this._client.selfbot) return true;\n\n\t\tconst storage: GuildStorage = this._client.storage.guilds.get(message.guild.id);\n\t\tconst limitedCommands: { [name: string]: string[] } = await storage.settings.get('limitedCommands') || {};\n\n\t\tif (!limitedCommands[command.name]) return true;\n\t\tif (limitedCommands[command.name].length === 0) return true;\n\n\t\treturn message.member.roles.filter(role =>\n\t\t\tlimitedCommands[command.name].includes(role.id)).size > 0;\n\t}\n\n\t/**\n\t * Return whether or not the user has one of the roles specified\n\t * in the command's requisite roles\n\t */\n\tprivate hasRoles(command: Command, message: Message, dm: boolean): boolean\n\t{\n\t\treturn this._client.selfbot || command.roles.length === 0 || dm\n\t\t\t|| message.member.roles.filter(role =>\n\t\t\t\tcommand.roles.includes(role.name)).size > 0;\n\t}\n\n\t/**\n\t * Return an error for unknown commands in DMs\n\t */\n\tprivate unknownCommandError(res: ResourceLoader): string\n\t{\n\t\treturn res(s.DISPATCHER_ERR_UNKNOWN_COMMAND);\n\t}\n\n\t/**\n\t * Return an error for guild only commands\n\t */\n\tprivate guildOnlyError(res: ResourceLoader): string\n\t{\n\t\treturn res(s.DISPATCHER_ERR_GUILD_ONLY);\n\t}\n\n\t/**\n\t * Return an error for missing caller permissions\n\t */\n\tprivate missingClientPermissionsError(res: ResourceLoader, missing: PermissionResolvable[]): string\n\t{\n\t\treturn res(s.DISPATCHER_ERR_MISSING_CLIENT_PERMISSIONS, { missing: missing.join(', ') });\n\t}\n\n\t/**\n\t * Return an error for missing caller permissions\n\t */\n\tprivate missingCallerPermissionsError(res: ResourceLoader, missing: PermissionResolvable[]): string\n\t{\n\t\treturn res(s.DISPATCHER_ERR_MISSING_CALLER_PERMISSIONS, { missing: missing.join(', ') });\n\t}\n\n\t/**\n\t * Return an error for failing a command limiter\n\t */\n\tprivate async failedLimiterError(res: ResourceLoader, command: Command, message: Message): Promise<string>\n\t{\n\t\tconst storage: GuildStorage = this._client.storage.guilds.get(message.guild.id);\n\t\tconst limitedCommands: { [name: string]: string[] } = await storage.settings.get('limitedCommands');\n\t\tconst roles: string[] = message.guild.roles\n\t\t\t.filter(r => limitedCommands[command.name].includes(r.id))\n\t\t\t.map(r => r.name);\n\n\t\treturn res(s.DISPATCHER_ERR_MISSING_ROLES, { roles: roles.join(', ')});\n\t}\n\n\t/**\n\t * Return an error for missing roles\n\t */\n\tprivate missingRolesError(res: ResourceLoader, command: Command): string\n\t{\n\t\treturn res(s.DISPATCHER_ERR_MISSING_ROLES, { roles: command.roles.join(', ') });\n\t}\n}\n"],"sourceRoot":"../../src"}