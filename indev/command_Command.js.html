<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>command/Command.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="/index.html">Stable</a><a href="/indev/index.html">Indev</a></h2><h3>Pages</h3><ul><li><a href="tutorial-LocalizationGuide.html">Localization Guide</a></li><li><a href="tutorial-LocalizationHelptext.html">Localizing Command helptext</a></li><li><a href="tutorial-LocalizationStrings.html">Localization string list</a></li><li><a href="tutorial-PluginAuthoring.html">Plugin Authoring Guide</a></li><li><a href="tutorial-PluginList.html">Plugin list</a></li><li><a href="tutorial-StartingInV3.html">Starting a bot in 3.0.0</a></li></ul><h3>Classes</h3><ul><li><a href="Client.html">Client</a></li><li><a href="ClientStorage.html">ClientStorage</a></li><li><a href="Command.html">Command</a></li><li><a href="CommandLock.html">CommandLock</a></li><li><a href="CommandRegistry.html">CommandRegistry</a></li><li><a href="CompactModeHelper.html">CompactModeHelper</a></li><li><a href="Database.html">Database</a></li><li><a href="Event.html">Event</a></li><li><a href="EventLoader.html">EventLoader</a></li><li><a href="GuildSettings.html">GuildSettings</a></li><li><a href="GuildStorage.html">GuildStorage</a></li><li><a href="KeyedStorage.html">KeyedStorage</a></li><li><a href="Logger.html">Logger</a></li><li><a href="Plugin.html">Plugin</a></li><li><a href="PluginLoader.html">PluginLoader</a></li><li><a href="RateLimit.html">RateLimit</a></li><li><a href="RateLimiter.html">RateLimiter</a></li><li><a href="RateLimitManager.html">RateLimitManager</a></li><li><a href="Resolver.html">Resolver</a></li><li><a href="ResolverLoader.html">ResolverLoader</a></li><li><a href="SharedProviderStorage.html">SharedProviderStorage</a></li><li><a href="SingleProviderStorage.html">SingleProviderStorage</a></li><li><a href="StorageProvider.html">StorageProvider</a></li></ul><h3>Interfaces</h3><ul><li><a href="IPlugin.html">IPlugin</a></li><li><a href="IStorageProvider.html">IStorageProvider</a></li></ul><h3>Mixins</h3><ul><li><a href="Guild.html">Guild</a></li><li><a href="Loggable.html">Loggable</a></li><li><a href="Message.html">Message</a></li></ul><h3>Modules</h3><ul><li><a href="module-CommandDecorators.html">CommandDecorators</a></li><li><a href="module-Lang.html">Lang</a></li><li><a href="module-ListenerUtil.html">ListenerUtil</a></li><li><a href="module-Middleware.html">Middleware</a></li><li><a href="module-Providers.html">Providers</a></li><li><a href="module-Time.html">Time</a></li><li><a href="module-Util.html">Util</a></li></ul><h3>Decorators</h3><ul><li><a href="global.html#deprecatedClass">deprecatedClass</a></li><li><a href="global.html#deprecatedMethod">deprecatedMethod</a></li><li><a href="global.html#logger">logger</a></li></ul><h3>TypeDefs</h3><ul><li><a href="global.html#ArgOpts">ArgOpts</a></li><li><a href="global.html#BaseResolverType">BaseResolverType</a></li><li><a href="global.html#BaseStrings">BaseStrings</a></li><li><a href="global.html#CommandInfo">CommandInfo</a></li><li><a href="global.html#DefaultGuildSettings">DefaultGuildSettings</a></li><li><a href="global.html#Difference">Difference</a></li><li><a href="global.html#LocalizedCommandInfo">LocalizedCommandInfo</a></li><li><a href="global.html#LogData">LogData</a></li><li><a href="global.html#LogLevel">LogLevel</a></li><li><a href="global.html#MiddlewareFunction">MiddlewareFunction</a></li><li><a href="global.html#PluginConstructor">PluginConstructor</a></li><li><a href="global.html#ResolverConstructor">ResolverConstructor</a></li><li><a href="global.html#ResourceLoader">ResourceLoader</a></li><li><a href="global.html#ResourceProxy">ResourceProxy</a></li><li><a href="global.html#RespondOptions">RespondOptions</a></li><li><a href="global.html#StorageProviderConstructor">StorageProviderConstructor</a></li><li><a href="global.html#TemplateData">TemplateData</a></li><li><a href="global.html#Transport">Transport</a></li><li><a href="global.html#TransportFunction">TransportFunction</a></li><li><a href="global.html#Tuple">Tuple</a></li><li><a href="global.html#YAMDBFOptions">YAMDBFOptions</a></li></ul><h3>Externals</h3><ul><li><a href="external-Client.html">Client</a></li><li><a href="external-ClientOptions.html">ClientOptions</a></li><li><a href="external-Collection.html">Collection</a></li><li><a href="external-Guild.html">Guild</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-MessageOptions.html">MessageOptions</a></li><li><a href="external-PermissionResolvable.html">PermissionResolvable</a></li><li><a href="external-Role.html">Role</a></li><li><a href="external-User.html">User</a></li></ul>
</nav>

<div id="main">
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable complexity */
import { PermissionResolvable, Permissions, MessageOptions } from 'discord.js';
import { ArgOpts } from '../types/ArgOpts';
import { Client } from '../client/Client';
import { CommandInfo } from '../types/CommandInfo';
import { CommandLock } from './CommandLock';
import { CompactModeHelper } from './CompactModeHelper';
import { Message } from '../types/Message';
import { MiddlewareFunction } from '../types/MiddlewareFunction';
import { RespondOptions } from '../types/RespondOptions';
import { Util } from '../util/Util';

/**
 * Action to be executed when the command is called. The following parameters
 * are what command actions will be passed by the {@link CommandDispatcher} whenever
 * a command is called. Be sure to receive these in proper order when writing
 * new commands
 * @abstract
 * @method Command#action
 * @param {external:Message} message Discord.js message object
 * @param {any[]} args An array containing the args parsed from the command calling message.&lt;br>
 * 					   Will contain strings unless middleware is used to transform the args
 * @returns {any}
 */

/**
 * Command class to extend to create commands users can execute
 * @abstract
 * @param {CommandInfo} info - Object containing required command properties
 */
export abstract class Command&lt;T extends Client = Client>
{
	private _disabled!: boolean;
	private _ratelimit!: string;

	public client!: T;
	public name!: string;
	public desc!: string;
	public usage!: string;
	public info!: string;
	public group!: string;
	public aliases!: string[];
	public guildOnly!: boolean;
	public hidden!: boolean;
	public argOpts!: ArgOpts;
	public callerPermissions!: PermissionResolvable[];
	public clientPermissions!: PermissionResolvable[];
	public roles!: string[];
	public ownerOnly!: boolean;
	public external!: boolean;
	public lock!: CommandLock;
	public lockTimeout!: number;

	// Internals
	public readonly middleware: MiddlewareFunction[];
	public classloc!: string;
	public initialized: boolean;

	public constructor(info?: CommandInfo)
	{
		/**
		 * YAMDBF Client instance
		 * @name Command#client
		 * @type {Client}
		 */

		/**
		 * The name of the command, used by the dispatcher
		 * to determine the command being executed
		 * @name Command#name
		 * @type {string}
		 */

		/**
		 * A brief description of the command, displayed
		 * in the commands list via the Help command
		 * @name Command#desc
		 * @type {string}
		 */

		/**
		 * An example of command usage. The token `&lt;prefix>` will
		 * be replaced by the guild-specific command prefix in the Help command when
		 * `help &lt;command>` is called
		 * @name Command#usage
		 * @type {string}
		 */

		/**
		 * Extra information about the command to be displayed
		 * by the Help command when `help &lt;command>` is called
		 * @name Command#info
		 * @type {string}
		 */

		/**
		 * The command group that the command belongs to. Allows commands to be
		 * grouped for disabling. The group 'base' cannot be disabled.
		 * @name Command#group
		 * @type {string}
		 */

		/**
		 * Aliases the command can be called by other than its name
		 * @name Command#aliases
		 * @type {string[]}
		 */

		/**
		 * Whether or not a command can only be used within a
		 * guild text channel
		 * @name Command#guildOnly
		 * @type {boolean}
		 */

		/**
		 * Whether or not the command is to be hidden from the
		 * commands list via the default help command
		 * @name Command#hidden
		 * @type {boolean}
		 */

		/**
		 * Options for how arguments should be parsed.&lt;br>
		 * **See:** {@link ArgOpts}
		 * @name Command#argOpts
		 * @type {ArgOpts}
		 */

		/**
		 * Array of permissions required by the command
		 * caller to be able to execute the command in
		 * the guild the command is called in.
		 *
		 * If any permissions are provided the command's `guildOnly`
		 * property will be automatically overridden to true
		 * @name Command#callerPermissions
		 * @type {external:PermissionResolvable[]}
		 */

		/**
		 * Array of permissions required by the client
		 * to be able to execute the command in the guild
		 * the command is called in.
		 *
		 * If any permissions are provided the command's `guildOnly`
		 * property will be automatically overridden to true
		 * @name Command#clientPermissions
		 * @type {external:PermissionResolvable[]}
		 */

		/**
		 * Array of specific {@link external:Role} names required to use the command.
		 * If the command caller has any (even just one) of the roles in the array,
		 * they will be able to use the command.
		 *
		 * If any roles are provided the command's `guildOnly` property will be
		 * automatically set to `true`
		 *
		 * >**Note:** This is far inferior to {@link Command#callerPermissions},
		 * using the base `limit` command's role-limiting system, or really even
		 * a custom-engineered solution to control who can use a command. Forcing
		 * servers to create Roles with specific names makes your bot that much
		 * less configurable on a per-guild basis, and configurability is what
		 * YAMDBF is all about. But, for the sake of simplicity, this is available
		 * @name Command#roles
		 * @type {string[]}
		 */

		/**
		 * Whether or not the command can be used only by the client/bot owner(s).&lt;br>
		 * **See:** [Client#config.owner]{@link Client#config}
		 * @name Command#ownerOnly
		 * @type {boolean}
		 */

		/**
		 * Whether or not this command was registered via {@link CommandRegistry#registerExternal}
		 * by some means other than the command loader like a Plugin
		 * @name Command#external
		 * @type {boolean}
		 */

		/**
		 * The CommmandLock this command uses. Must be assigned manually if
		 * locking functionality is desired
		 * @name Command#lock
		 * @type {CommandLock}
		 */

		/**
		 * Time until command locks will be cancelled if a command
		 * does not finish in time
		 * @name Command#lockTimeout
		 * @type {number}
		 */

		// Middleware function storage for the Command instance
		this.middleware = [];

		this.initialized = false;

		if (info) Object.assign(this, info);
	}

	// Docs above class
	public abstract action(message: Message, args: any[]): any;

	/**
	 * The ratelimit for this command per user
	 * @type {string}
	 */
	public get ratelimit(): string { return this._ratelimit; }
	public set ratelimit(value: string)
	{
		Util.parseRateLimit(value);
		this._ratelimit = value;
	}

	/**
	 * Can be included in a command to initlialize any resources a command
	 * needs at runtime that require things that are not available within
	 * a command's constructor like the client instance or client/guild storages.
	 *
	 * Will be called after all commands are loaded (including those from
	 * any loaded plugins) and after all base framework storages (client and guild)
	 * are ready for use.
	 *
	 * >**Note:** Can be async if needed
	 * @abstract
	 * @returns {Promise&lt;void>}
	 */
	public init(): void {}

	/**
	 * Make necessary asserts for Command validity.
	 * Called internally by the command loader
	 * @private
	 */
	public register(client: T): void
	{
		this.client = client;

		// Set defaults if not present
		if (typeof this.aliases === 'undefined') this.aliases = [];
		if (typeof this.group === 'undefined') this.group = 'base';
		if (typeof this.guildOnly === 'undefined') this.guildOnly = false;
		if (typeof this.hidden === 'undefined') this.hidden = false;
		if (typeof this.argOpts === 'undefined') this.argOpts = {};
		if (typeof this.argOpts.separator === 'undefined') this.argOpts.separator = ' ';
		if (typeof this.callerPermissions === 'undefined') this.callerPermissions = [];
		if (typeof this.clientPermissions === 'undefined') this.clientPermissions = [];
		if (typeof this.roles === 'undefined') this.roles = [];
		if (typeof this.ownerOnly === 'undefined') this.ownerOnly = false;
		if (typeof this.external === 'undefined') this.external = false;
		if (typeof this._disabled === 'undefined') this._disabled = false;
		if (typeof this.classloc === 'undefined') this.classloc = '&lt;External Command>';
		if (typeof this.lockTimeout === 'undefined') this.lockTimeout = 30e3;

		// Make necessary asserts
		if (!this.name) throw new Error(`A command is missing a name:\n${this.classloc}`);
		if (!this.desc) throw new Error(`A description must be provided for Command: ${this.name}`);
		if (!this.usage) throw new Error(`Usage information must be provided for Command: ${this.name}`);
		if (this.aliases &amp;&amp; !Array.isArray(this.aliases))
			throw new TypeError(`Aliases for Command "${this.name}" must be an array of alias strings`);

		if (this.callerPermissions &amp;&amp; !Array.isArray(this.callerPermissions))
			throw new TypeError(`\`callerPermissions\` for Command "${this.name}" must be an array`);

		if (this.clientPermissions &amp;&amp; !Array.isArray(this.clientPermissions))
			throw new TypeError(`\`clientPermissions\` for Command "${this.name}" must be an array`);

		if (this.callerPermissions &amp;&amp; this.callerPermissions.length)
			this._validatePermissions('callerPermissions', this.callerPermissions);

		if (this.clientPermissions &amp;&amp; this.clientPermissions.length)
			this._validatePermissions('clientPermissions', this.clientPermissions);

		if (this.roles &amp;&amp; !Array.isArray(this.roles))
			throw new TypeError(`\`roles\` for Command "${this.name}" must be an array`);

		if (typeof this.lockTimeout !== 'undefined' &amp;&amp; typeof this.lockTimeout !== 'number')
			throw new TypeError(`\`lockTimeout\` for Command "${this.name}" must be a number`);

		if (typeof this.action === 'undefined' || !(this.action instanceof Function))
			throw new TypeError(`Command "${this.name}".action: expected Function, got: ${typeof this.action}`);

		// Default guildOnly to true if permissions/roles are given
		if (!this.guildOnly
			&amp;&amp; (this.callerPermissions.length
				|| this.clientPermissions.length
				|| this.roles.length))
			this.guildOnly = true;

		if (typeof this.lock !== 'undefined' &amp;&amp; !this.guildOnly)
			throw new Error(`Command "${this.name} has a defined lock but is not guildOnly`);
	}

	/**
	 * Whether or not this command is disabled
	 * @type {boolean}
	 */
	public get disabled(): boolean
	{
		return this._disabled;
	}

	/**
	 * Enable this command if it is disabled
	 * @returns {void}
	 */
	public enable(): void
	{
		this._disabled = false;
	}

	/**
	 * Disable this command if it is enabled
	 * @returns {void}
	 */
	public disable(): void
	{
		this._disabled = true;
	}

	/**
	 * Adds a middleware function to be used when the command is called
	 * to make modifications to args, determine if the command can
	 * be run, or anything else you want to do whenever this command
	 * is called.
	 *
	 * See {@link MiddlewareFunction} for information on how a middleware
	 * function should be represented
	 *
	 * Usage example:
	 * ```
	 * &lt;Client>.use((message, args) => [message, args.map(a => a.toUpperCase())]);
	 * ```
	 * This will add a middleware function to this command that will attempt
	 * to transform all args to uppercase. This will of course fail if any
	 * of the args are not a string.
	 *
	 * >**Note:** Middleware functions should only be added to a command one
	 * time each and thus should not be added within any sort of event or loop.
	 * Multiple separate middleware functions can be added to the via multiple
	 * separate calls to this method
	 * @param {MiddlewareFunction} func The middleware function to use
	 * @returns {Command}
	 */
	public use(func: MiddlewareFunction): this
	{
		this.middleware.push(func);
		return this;
	}

	protected async respond(message: Message, response: string, options?: MessageOptions): Promise&lt;Message | Message[]>;
	protected async respond(message: Message, response: string, options?: RespondOptions): Promise&lt;void>;

	/**
	 * Send provided response to the provided message's channel,
	 * leveraging compact mode mechanics if enabled
	 * @protected
	 * @param {external:Message} message Discord.js Message object
	 * @param {string} response String to send
	 * @param {RespondOptions} [options] Optional options for the response
	 * @returns {Promise&lt;external:Message | external:Message[] | undefined>}
	 */
	protected async respond(...args: any[]): Promise&lt;any>
	{
		const [message, response, options]: [Message, string, RespondOptions] = args as any;

		if (typeof options !== 'undefined'
			&amp;&amp; typeof options.button !== 'undefined'
			&amp;&amp; (await message.guild.storage!.settings.get('compact') || this.client.compact))
		{
			if (message.reactions.cache.size > 0) await message.reactions.removeAll();
			CompactModeHelper.registerButton(
				message,
				this.client.buttons[options.button] || options.button,
				async () => message.channel.send(response, options)
			);
			return;
		}

		return message.channel.send(response, options);
	}

	/**
	 * Validate PermissionResolvables in the given array, throwing an error
	 * for any that are invalid
	 * @private
	 */
	private _validatePermissions(field: string, perms: PermissionResolvable[]): void
	{
		const errString: (i: number, err: any) => string = (i, err) =>
			`Command "${this.name}" permission "${perms[i]}" in ${field}[${i}] is not a valid permission.\n\n${err}`;

		for (const [index, perm] of perms.entries())
			try { Permissions.resolve(perm); }
			catch (err) { throw new TypeError(errString(index, err)); }
	}
}
</code></pre>
        </article>
    </section>





</div>

<br class="clear">

<footer>
	<div align="right">
    	<a href="https://github.com/jsdoc3/jsdoc">JSDoc3.5.0-dev</a> | Minami
	</div>
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
