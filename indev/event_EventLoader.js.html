<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>event/EventLoader.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="/index.html">Stable</a><a href="/indev/index.html">Indev</a></h2><h3>Pages</h3><ul><li><a href="tutorial-LocalizationGuide.html">Localization Guide</a></li><li><a href="tutorial-LocalizationHelptext.html">Localizing Command helptext</a></li><li><a href="tutorial-LocalizationStrings.html">Localization string list</a></li><li><a href="tutorial-PluginAuthoring.html">Plugin Authoring Guide</a></li><li><a href="tutorial-PluginList.html">Plugin list</a></li><li><a href="tutorial-StartingInV3.html">Starting a bot in 3.0.0</a></li></ul><h3>Classes</h3><ul><li><a href="Client.html">Client</a></li><li><a href="ClientStorage.html">ClientStorage</a></li><li><a href="Command.html">Command</a></li><li><a href="CommandLock.html">CommandLock</a></li><li><a href="CommandRegistry.html">CommandRegistry</a></li><li><a href="CompactModeHelper.html">CompactModeHelper</a></li><li><a href="Database.html">Database</a></li><li><a href="Event.html">Event</a></li><li><a href="EventLoader.html">EventLoader</a></li><li><a href="GuildSettings.html">GuildSettings</a></li><li><a href="GuildStorage.html">GuildStorage</a></li><li><a href="KeyedStorage.html">KeyedStorage</a></li><li><a href="Logger.html">Logger</a></li><li><a href="Plugin.html">Plugin</a></li><li><a href="PluginLoader.html">PluginLoader</a></li><li><a href="RateLimit.html">RateLimit</a></li><li><a href="RateLimiter.html">RateLimiter</a></li><li><a href="RateLimitManager.html">RateLimitManager</a></li><li><a href="Resolver.html">Resolver</a></li><li><a href="ResolverLoader.html">ResolverLoader</a></li><li><a href="SharedProviderStorage.html">SharedProviderStorage</a></li><li><a href="SingleProviderStorage.html">SingleProviderStorage</a></li><li><a href="StorageProvider.html">StorageProvider</a></li></ul><h3>Interfaces</h3><ul><li><a href="IPlugin.html">IPlugin</a></li><li><a href="IStorageProvider.html">IStorageProvider</a></li></ul><h3>Mixins</h3><ul><li><a href="Guild.html">Guild</a></li><li><a href="Loggable.html">Loggable</a></li><li><a href="Message.html">Message</a></li></ul><h3>Modules</h3><ul><li><a href="module-CommandDecorators.html">CommandDecorators</a></li><li><a href="module-Lang.html">Lang</a></li><li><a href="module-ListenerUtil.html">ListenerUtil</a></li><li><a href="module-Middleware.html">Middleware</a></li><li><a href="module-Providers.html">Providers</a></li><li><a href="module-Time.html">Time</a></li><li><a href="module-Util.html">Util</a></li></ul><h3>Decorators</h3><ul><li><a href="global.html#deprecatedClass">deprecatedClass</a></li><li><a href="global.html#deprecatedMethod">deprecatedMethod</a></li><li><a href="global.html#logger">logger</a></li></ul><h3>TypeDefs</h3><ul><li><a href="global.html#ArgOpts">ArgOpts</a></li><li><a href="global.html#BaseResolverType">BaseResolverType</a></li><li><a href="global.html#BaseStrings">BaseStrings</a></li><li><a href="global.html#CommandInfo">CommandInfo</a></li><li><a href="global.html#DefaultGuildSettings">DefaultGuildSettings</a></li><li><a href="global.html#Difference">Difference</a></li><li><a href="global.html#LocalizedCommandInfo">LocalizedCommandInfo</a></li><li><a href="global.html#LogData">LogData</a></li><li><a href="global.html#LogLevel">LogLevel</a></li><li><a href="global.html#MiddlewareFunction">MiddlewareFunction</a></li><li><a href="global.html#PluginConstructor">PluginConstructor</a></li><li><a href="global.html#ResolverConstructor">ResolverConstructor</a></li><li><a href="global.html#ResourceLoader">ResourceLoader</a></li><li><a href="global.html#ResourceProxy">ResourceProxy</a></li><li><a href="global.html#RespondOptions">RespondOptions</a></li><li><a href="global.html#StorageProviderConstructor">StorageProviderConstructor</a></li><li><a href="global.html#TemplateData">TemplateData</a></li><li><a href="global.html#Transport">Transport</a></li><li><a href="global.html#TransportFunction">TransportFunction</a></li><li><a href="global.html#Tuple">Tuple</a></li><li><a href="global.html#YAMDBFOptions">YAMDBFOptions</a></li></ul><h3>Externals</h3><ul><li><a href="external-Client.html">Client</a></li><li><a href="external-ClientOptions.html">ClientOptions</a></li><li><a href="external-Collection.html">Collection</a></li><li><a href="external-Guild.html">Guild</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-MessageOptions.html">MessageOptions</a></li><li><a href="external-PermissionResolvable.html">PermissionResolvable</a></li><li><a href="external-Role.html">Role</a></li><li><a href="external-User.html">User</a></li></ul>
</nav>

<div id="main">
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as glob from 'glob';
import * as path from 'path';
import { logger, Logger } from '../util/logger/Logger';
import { Client } from '../client/Client';
import { Event } from './Event';
import { EventRegistry } from './EventRegistry';
import { Util } from '../util/Util';

/**
 * Handles loading and registering Event class event handlers from
 * registered source directories.
 */
export class EventLoader
{
	@logger('EventLoader')
	private readonly _logger!: Logger;

	private readonly _client: Client;
	private readonly _sources: string[];
	private readonly _registry: EventRegistry;

	public constructor(client: Client)
	{
		this._client = client;
		this._sources = [];
		this._registry = new EventRegistry(client);
	}

	/**
	 * Registers a source directory to load Event class event handlers from.
	 * Does nothing if the directory is already registered. Events will be loaded
	 * by the Client after the `continue` event is emitted at runtime
	 * @returns {void}
	 */
	public addSourceDir(dir: string): void
	{
		const resolvedDir: string = path.resolve(dir);
		if (this._sources.includes(resolvedDir)) return;
		this._sources.push(resolvedDir);
	}

	/**
	 * Returns whether or not the EventLoader has any registered source directories
	 * @returns {boolean}
	 */
	public hasSources(): boolean
	{
		return this._sources.length > 0;
	}

	/**
	 * Loads or reloads all Events from all registered sources. Allows for hot-reloading
	 * @returns {number} The total number of loaded or reloaded events
	 */
	public loadFromSources(): number
	{
		this._clearEvents();

		let loadedEvents: number = 0;
		for (const source of this._sources)
			loadedEvents += this._loadEventsFrom(source);

		return loadedEvents;
	}

	/**
	 * Unregisters and clears all loaded Event class event handlers
	 * @private
	 */
	private _clearEvents(): void
	{
		this._registry.clearRegisteredEvents();
	}

	/**
	 * Load events from the given directory
	 * @private
	 */
	private _loadEventsFrom(dir: string): number
	{
		// Glob all the javascript files in the directory
		let eventFiles: string[] = glob.sync(`${dir}/**/*.js`);

		// Glob typescript files if `tsNode` is enabled
		if (this._client.tsNode)
		{
			eventFiles.push(...glob.sync(`${dir}/**/!(*.d).ts`));
			const filteredEventFiles: string[] = eventFiles.filter(f =>
			{
				const file: string = f.match(/\/([^/]+?)\.[j|t]s$/)![1];
				if (f.endsWith('.ts')) return true;
				if (f.endsWith('.js'))
					return !eventFiles.some(cf => cf.endsWith(`${file}.ts`));

				return false;
			});
			eventFiles = filteredEventFiles;
		}

		const loadedEvents: Event[] = [];
		this._logger.debug(`Loading events in: ${dir}`);

		// Load and instantiate every event from the globbed files
		for (const file of eventFiles)
		{
			// Delete the cached event file for hot-reloading
			delete require.cache[require.resolve(file)];

			const loadedFile: any = require(file);
			const eventClasses: (new () => Event)[] = this._findEventClasses(loadedFile);

			if (eventClasses.length === 0)
			{
				this._logger.warn(`Failed to find Event class in file: ${file}`);
				continue;
			}

			for (const EventClass of eventClasses)
			{
				const eventInstance: Event = new EventClass();

				this._logger.info(`Loaded Event handler for event: ${eventInstance.name}`);
				loadedEvents.push(eventInstance);
			}
		}

		// Register all of the loaded events
		for (const event of loadedEvents)
		{
			event._register(this._client);
			this._registry.register(event);
		}

		return loadedEvents.length;
	}

	/**
	 * Recursively search for Event classes within the given object
	 * @private
	 */
	private _findEventClasses(obj: any): (new () => Event)[]
	{
		const foundClasses: ((new () => Event) | (new () => Event)[])[] = [];
		const keys: string[] = Object.keys(obj);
		if (Event.prototype.isPrototypeOf(obj.prototype))
			foundClasses.push(obj);

		else if (keys.length > 0)
			for (const key of keys)
				if (Event.prototype.isPrototypeOf(obj[key].prototype))
					foundClasses.push(this._findEventClasses(obj[key]));

		return Util.flattenArray(foundClasses);
	}
}
</code></pre>
        </article>
    </section>





</div>

<br class="clear">

<footer>
	<div align="right">
    	<a href="https://github.com/jsdoc3/jsdoc">JSDoc3.5.0-dev</a> | Minami
	</div>
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
