<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>command/CommandRegistry.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="/index.html">Stable</a><a href="/indev/index.html">Indev</a></h2><h3>Pages</h3><ul><li><a href="tutorial-LocalizationGuide.html">Localization Guide</a></li><li><a href="tutorial-LocalizationHelptext.html">Localizing Command helptext</a></li><li><a href="tutorial-LocalizationStrings.html">Localization string list</a></li><li><a href="tutorial-PluginAuthoring.html">Plugin Authoring Guide</a></li><li><a href="tutorial-PluginList.html">Plugin list</a></li><li><a href="tutorial-StartingInV3.html">Starting a bot in 3.0.0</a></li></ul><h3>Classes</h3><ul><li><a href="Client.html">Client</a></li><li><a href="ClientStorage.html">ClientStorage</a></li><li><a href="Command.html">Command</a></li><li><a href="CommandLock.html">CommandLock</a></li><li><a href="CommandRegistry.html">CommandRegistry</a></li><li><a href="CompactModeHelper.html">CompactModeHelper</a></li><li><a href="Database.html">Database</a></li><li><a href="Event.html">Event</a></li><li><a href="EventLoader.html">EventLoader</a></li><li><a href="GuildSettings.html">GuildSettings</a></li><li><a href="GuildStorage.html">GuildStorage</a></li><li><a href="KeyedStorage.html">KeyedStorage</a></li><li><a href="Logger.html">Logger</a></li><li><a href="Plugin.html">Plugin</a></li><li><a href="PluginLoader.html">PluginLoader</a></li><li><a href="RateLimit.html">RateLimit</a></li><li><a href="RateLimiter.html">RateLimiter</a></li><li><a href="RateLimitManager.html">RateLimitManager</a></li><li><a href="Resolver.html">Resolver</a></li><li><a href="ResolverLoader.html">ResolverLoader</a></li><li><a href="SharedProviderStorage.html">SharedProviderStorage</a></li><li><a href="SingleProviderStorage.html">SingleProviderStorage</a></li><li><a href="StorageProvider.html">StorageProvider</a></li></ul><h3>Interfaces</h3><ul><li><a href="IPlugin.html">IPlugin</a></li><li><a href="IStorageProvider.html">IStorageProvider</a></li></ul><h3>Mixins</h3><ul><li><a href="Guild.html">Guild</a></li><li><a href="Loggable.html">Loggable</a></li><li><a href="Message.html">Message</a></li></ul><h3>Modules</h3><ul><li><a href="module-CommandDecorators.html">CommandDecorators</a></li><li><a href="module-Lang.html">Lang</a></li><li><a href="module-ListenerUtil.html">ListenerUtil</a></li><li><a href="module-Middleware.html">Middleware</a></li><li><a href="module-Providers.html">Providers</a></li><li><a href="module-Time.html">Time</a></li><li><a href="module-Util.html">Util</a></li></ul><h3>Decorators</h3><ul><li><a href="global.html#deprecatedClass">deprecatedClass</a></li><li><a href="global.html#deprecatedMethod">deprecatedMethod</a></li><li><a href="global.html#logger">logger</a></li></ul><h3>TypeDefs</h3><ul><li><a href="global.html#ArgOpts">ArgOpts</a></li><li><a href="global.html#BaseResolverType">BaseResolverType</a></li><li><a href="global.html#BaseStrings">BaseStrings</a></li><li><a href="global.html#CommandInfo">CommandInfo</a></li><li><a href="global.html#DefaultGuildSettings">DefaultGuildSettings</a></li><li><a href="global.html#Difference">Difference</a></li><li><a href="global.html#LocalizedCommandInfo">LocalizedCommandInfo</a></li><li><a href="global.html#LogData">LogData</a></li><li><a href="global.html#LogLevel">LogLevel</a></li><li><a href="global.html#MiddlewareFunction">MiddlewareFunction</a></li><li><a href="global.html#PluginConstructor">PluginConstructor</a></li><li><a href="global.html#ResolverConstructor">ResolverConstructor</a></li><li><a href="global.html#ResourceLoader">ResourceLoader</a></li><li><a href="global.html#ResourceProxy">ResourceProxy</a></li><li><a href="global.html#RespondOptions">RespondOptions</a></li><li><a href="global.html#StorageProviderConstructor">StorageProviderConstructor</a></li><li><a href="global.html#TemplateData">TemplateData</a></li><li><a href="global.html#Transport">Transport</a></li><li><a href="global.html#TransportFunction">TransportFunction</a></li><li><a href="global.html#Tuple">Tuple</a></li><li><a href="global.html#YAMDBFOptions">YAMDBFOptions</a></li></ul><h3>Externals</h3><ul><li><a href="external-Client.html">Client</a></li><li><a href="external-ClientOptions.html">ClientOptions</a></li><li><a href="external-Collection.html">Collection</a></li><li><a href="external-Guild.html">Guild</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-MessageOptions.html">MessageOptions</a></li><li><a href="external-PermissionResolvable.html">PermissionResolvable</a></li><li><a href="external-Role.html">Role</a></li><li><a href="external-User.html">User</a></li></ul>
</nav>

<div id="main">
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Client } from '../client/Client';
import { Command } from './Command';
import { Collection } from 'discord.js';
import { Logger, logger } from '../util/logger/Logger';

/**
 * @classdesc Stores loaded Commands in a Collection keyed by each Command's `name` property
 * @class CommandRegistry
 * @extends {external:Collection}
 */
export class CommandRegistry&lt;
	T extends Client,
	K extends string = string,
	V extends Command&lt;T> = Command&lt;T>>
	extends Collection&lt;K, V>
{
	@logger('CommandRegistry')
	private readonly _logger!: Logger;
	private readonly _client!: T;
	private readonly _reserved!: ((() => string) | string)[];

	public constructor(client: T)
	{
		super();
		Object.defineProperty(this, '_client', { value: client });

		Object.defineProperty(this, '_reserved', {
			value: [
				() => this.has('limit' as K) ? 'clear' : null
			]
		});
	}

	public static get [Symbol.species]() {
		return Collection as any;
	}

	/**
	 * Contains all [Command groups]{@link Command#group}
	 * @readonly
	 * @type {string[]}
	 */
	public get groups(): string[]
	{
		return Array.from(new Set(this.map(c => c.group)));
	}

	/**
	 * Register an external command and add it to the `&lt;Client>.commands`
	 * [collection]{@link external:Collection}, erroring on duplicate
	 * aliases
	 *
	 * >**Note:** This is intended for Plugins to use to register external
	 * commands with the Client instance. Under normal circumstances
	 * commands should be added by placing them in the directory passed
	 * to the `commandsDir` YAMDBF Client option
	 * @param {Command} command The Command instance to be registered
	 * @returns {void}
	 */
	public registerExternal(command: Command&lt;any>): void
	{
		this._logger.info(`External command loaded: ${command.name}`);
		this._registerInternal(command as V, true);
	}

	/**
	 * Resolve the given Command name or alias to a registered Command
	 * @param {string} input Command name or alias
	 * @returns {Command | undefined}
	 */
	public resolve(input: string): V | undefined
	{
		input = input ? input.toLowerCase() : input;
		return this.find(c => c.name.toLowerCase() === input
			|| !!c.aliases.find(a => a.toLowerCase() === input));
	}

	/**
	 * Complete registration of a command and add to the parent collection.
	 *
	 * This is an internal method and should not be used. Use
	 * `registerExternal()` instead
	 * @private
	 */
	public _registerInternal(command: V, external: boolean = false): void
	{
		if (this.has(command.name as K))
		{
			if (!this.get(command.name as K)!.external)
				this._logger.info(`Replacing previously loaded command: ${command.name}`);
			else
				this._logger.info(`Replacing externally loaded command: ${command.name}`);

			this.delete(command.name as K);
		}
		this.set(command.name as K, command);
		command._register(this._client);
		if (external) command.external = true;
	}

	/**
	 * Check for duplicate aliases, erroring on any. Used internally
	 * @private
	 */
	public _checkDuplicateAliases(): void
	{
		for (const command of this.values())
			for (const alias of command.aliases)
			{
				const duplicate: V = this.filter(c => c !== command).find(c => c.aliases.includes(alias))!;
				const name: string = command.name;

				if (!duplicate) continue;
				if (!command.external)
					throw new Error(
						`Commands may not share aliases: ${name}, ${duplicate.name} (shared alias: "${alias}")`);

				else
					throw new Error([
						`External command "${duplicate.name}" has conflicting alias`,
						`with "${name}" (shared alias: "${alias}")`
					].join(' '));
			}
	}

	/**
	 * Check for commands with reserved names. Used internally
	 * @private
	 */
	public _checkReservedCommandNames(): void
	{
		const reserved: string[] = this._reserved.map(r => typeof r !== 'string' ? r() : r);
		for (const name of reserved)
		{
			if (!name) continue;

			const command: Command = this.resolve(name)!;
			if (command)
				throw new Error(`Command '${command.name}' is using reserved name or alias: '${name}'`);
		}
	}

	/**
	 * Run the `init()` method of all loaded commands.
	 * This is an internal method and should not be used
	 * @private
	 */
	public async _initCommands(): Promise&lt;boolean>
	{
		let success: boolean = true;
		for (const command of this.values())
		{
			if (command._initialized) continue;
			try
			{
				await command.init();
				command._initialized = true;
			}
			catch (err)
			{
				success = false;
				this._logger.error(
					`Command "${command.name}" errored during initialization: \n\n${err.stack}`,
					command.external ? '\n\nPlease report this error to the command author.\n' : '\n');
			}
		}
		return success;
	}
}
</code></pre>
        </article>
    </section>





</div>

<br class="clear">

<footer>
	<div align="right">
    	<a href="https://github.com/jsdoc3/jsdoc">JSDoc3.5.0-dev</a> | Minami
	</div>
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
